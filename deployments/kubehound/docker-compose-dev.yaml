version: "3.7"

services:
  mongodb:
    image: mongo
    container_name: storedb
    ports:
      - "127.0.0.1:27017:27017"
    volumes:
      - ./data/mongodb:/data/db

  mongo-express:
    image: mongo-express
    restart: always
    depends_on:
      - mongodb
    ports:
      - "127.0.0.1:8081:8081"
    environment:
      ME_CONFIG_MONGODB_URL: mongodb://mongodb:27017/

  janusgraph:
    build: ./janusgraph/
    container_name: graphdb-ng
    ports:
      - "127.0.0.1:8182:8182"
    volumes:
       # Named volume mounts. The data mount is only used when BerkeleyDB is used for storage.
      - "./data/janus:/var/lib/janusgraph"
    environment:
      - janusgraph.schema.constraints=true
      - janusgraph.schema.default=none
    healthcheck: 
      test: ["CMD", "/opt/janusgraph/bin/gremlin.sh", "-e", "/opt/janusgraph/scripts/health-check.groovy"]
      interval: 60s
      timeout: 30s
      retries: 1
      start_period: 15s

  datadog:
    image: gcr.io/datadoghq/agent:7
    pid: host
    ports:
      - ${DD_DOGSTATSD_PORT}:${DD_DOGSTATSD_PORT}
      - ${DD_APM_RECEIVER_PORT}:${DD_APM_RECEIVER_PORT}
    environment:
     - DD_API_KEY=${DD_API_KEY}
     - DD_DOGSTATSD_PORT=${DD_DOGSTATSD_PORT}
     - DD_EXPVAR_PORT=${DD_EXPVAR_PORT}
     - DD_APM_RECEIVER_PORT=${DD_APM_RECEIVER_PORT}
     - DD_SITE=datadoghq.com
     - DD_LOGS_ENABLED=true
     - DD_APM_ENABLED=true
    volumes:
     - /var/run/docker.sock:/var/run/docker.sock
     - /proc/:/host/proc/:ro
     - /sys/fs/cgroup:/host/sys/fs/cgroup:ro