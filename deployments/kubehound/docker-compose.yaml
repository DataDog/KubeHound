version: "3.8"
services:
  mongodb:
    image: mongo:6.0.6
    restart: unless-stopped
    profiles: ["infra"]
    container_name: ${COMPOSE_PROJECT_NAME}-storedb
    networks:
      - kubenet
    depends_on:
      janusgraph:
        condition: service_healthy
    labels:
      com.datadoghq.ad.logs: '[{"app": "mongodb", "service": "kubehound"}]'
    volumes:
      - ./mongo/docker-healthcheck:/usr/local/bin/docker-healthcheck
    healthcheck:
      test:  ["CMD", "docker-healthcheck"]
      interval: 10s
      timeout: 2s
      retries: 10

  janusgraph:
    build: ./janusgraph/
    restart: unless-stopped
    profiles: ["infra"]
    container_name: ${COMPOSE_PROJECT_NAME}-graphdb
    networks:
      - kubenet
    environment:
      #  Optimize for writes https://docs.janusgraph.org/operations/bulk-loading/
      - janusgraph.ids.block-size=3000000
      # Enforce strict schema constrains as per https://docs.janusgraph.org/configs/configuration-reference/#schema
      - janusgraph.schema.constraints=true
      - janusgraph.schema.default=none
      # Bump content length of web-socket buffer to enable bulk insert queries
      - gremlinserver.maxContentLength=2097152
      # Bump evaluation timeout to support our large datasets
      - gremlinserver.evaluationTimeout=240000
      # enabling metrics only for jmxReporter
      - gremlinserver.metrics.jmxReporter.enabled=true
      - gremlinserver.metrics.consoleReporter.enabled=false
      - gremlinserver.metrics.slf4jReporter.enabled=false
      - gremlinserver.metrics.graphiteReporter.enabled=false
      - gremlinserver.metrics.csvReporter.enabled=false
      # Performance tweaks based on: https://www.sailpoint.com/blog/souping-up-the-gremlin/
      - gremlinserver.gremlinPool=0 # will default to Runtime.availableProcessors()
      - gremlinserver.threadPoolWorker=8 # should be 2x VCPU (TODO: can we set dynamically?)
      # Custom SCRIPT plugin for DSL support
      - gremlinserver.scriptEngines.gremlin-groovy.plugins[org.apache.tinkerpop.gremlin.jsr223.ImportGremlinPlugin].classImports[+]=com.datadog.ase.kubehound.KubeHoundTraversalSource
      - gremlinserver.scriptEngines.gremlin-groovy.plugins[org.apache.tinkerpop.gremlin.jsr223.ImportGremlinPlugin].classImports[+]=com.datadog.ase.kubehound.EndpointExposure
      - gremlinserver.scriptEngines.gremlin-groovy.plugins[org.apache.tinkerpop.gremlin.jsr223.ScriptFileGremlinPlugin].files[+]=scripts/kubehound-dsl-init.groovy
    healthcheck:
      test: ["CMD", "bin/gremlin.sh", "-e", "scripts/remote-connect.groovy"]
      interval: 60s 
      timeout: 30s
      retries: 3
    labels:
      com.datadoghq.ad.logs: '[{"app": "janusgraph", "service": "kubehound"}]'

networks:
  kubenet: